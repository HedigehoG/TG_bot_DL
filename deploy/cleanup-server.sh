#!/bin/bash
#
# Скрипт для ПОЛНОГО удаления бота, его данных и пользователя с сервера.
# ВНИМАНИЕ: Это действие необратимо.
#
set -euo pipefail

# Проверяем, что скрипт запущен с правами root, так как он будет удалять пользователя.
if [ "$(id -u)" -ne 0 ]; then
  echo "Ошибка: Этот скрипт должен выполняться с правами root (через sudo)." >&2
  exit 1
fi

if [ -z "$1" ]; then
  echo "Ошибка: Имя пользователя для удаления не указано в качестве аргумента." >&2
  echo "Пример использования: sudo $0 <имя_пользователя>" >&2
  exit 1
fi

DEPLOY_USER="$1"
WORK_DIR="/home/${DEPLOY_USER}"

echo "--- Начало полного удаления для пользователя: ${DEPLOY_USER} ---"

# 1. Останавливаем и удаляем Docker-сервисы, связанные с ботом.
if [ -f "${WORK_DIR}/docker-compose.yml" ]; then
  echo "Найден docker-compose.yml. Останавливаем и удаляем сервисы..."
  # Переходим в рабочую директорию, чтобы docker-compose подхватил .env файлы
  cd "${WORK_DIR}"

  # Загружаем переменные из .env.server, чтобы docker-compose мог сделать подстановки (например, ${BOT_NAME})
  if [ -f .env.server ]; then
    set -o allexport
    source .env.server
    set +o allexport
  fi

  # ИСПОЛЬЗУЕМ 'docker compose' (v2) вместо устаревшего 'docker-compose' (v1)
  if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
    docker compose down --volumes --remove-orphans
    echo "Docker-сервисы остановлены и удалены."
  else
    echo "Предупреждение: Команда 'docker compose' не найдена. Пропускаем остановку сервисов."
  fi
  cd /
else
  echo "Файл docker-compose.yml не найден в ${WORK_DIR}. Пропускаем шаг с Docker."
fi

# 2. Запускаем отложенное удаление пользователя и выходим.
# Ваша идея с nohup правильная, но текущая реализация не сработает,
# так как `deluser` оборвет сессию до того, как выполнится остальная часть команды (`&& rm ...`).
#
# Ниже — более надежный способ. Мы запускаем в фоновом режиме (`&`) новую оболочку,
# которая сначала ждет пару секунд, а затем выполняет всю цепочку удаления.
# `nohup` гарантирует, что этот процесс не прервется после закрытия вашего терминала.

echo "Запуск финальной очистки в фоновом режиме..."
nohup bash -c "sleep 1 && userdel -rf '${DEPLOY_USER}' &>/dev/null && rm -f '/etc/sudoers.d/99-${DEPLOY_USER}-cleanup'" >/dev/null 2>&1 &

echo "--- Очистка запланирована. ---"
echo "Вы можете выходить из сессии. Удаление произойдет автоматически через несколько секунд."
